<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title>Movie Roulette V16 (Ultimate)</title>
    
    <link rel="manifest" href="data:application/manifest+json;base64,ewogICJuYW1lIjogIk1vdmllIFJvdWRPdHRlIiwKICAic2hvcnRfbmFtZSI6ICJNb3ZpZSBSb3VsZXR0ZSIsCiAgInN0YXJ0X3VybCI6ICIuIiwKICAiZGlzcGxheSI6ICJzdGFuZGFsb25lIiwKICAiYmFja2dyb3VuZF9jb2xvciI6ICIjRUZFRUU1IiwKICAidGhlbWVfY29xvciI6ICIjMDAwMDAwIiwKICAiaWNvbnMiOiBbCiAgICB7CiAgICAgICJzcmMiOiAiZGF0YTppbWFnZS9zdmcreG1sO2Jhc2U2NCxQSE4yWnlCM2IzVjBkQzxzYjJOamIyNWZabWxzWlQwc0ltNXZiVzkwWlM1a1pYUnpJRDBnTWpBd2lHaDBiVzVvWlQwaU1qQXdJaUIzYnlCMlpVZGxRMnhoYm1Ob1pYTXRhV1RnSWt4cGMzUnZkR2x2YmlJZ1kyOXVaR2xrSWlCM1pYa3RhV1RnSWxKdmRXeGxkR1JsSUhsd1pYSWdZbTl1WlcwaUlIMHNJbTVpWnlJNklrycGJuVjBaWEl2UGc9PSIsCiAgICAgICJzaXplcyI6ICIxOTJ4MTkyIiwKICAgICAgInR5cGUiOiAiaW1hZ2Uvc3ZnK3htbCIKICAgIH0KICBdCn0=" />
    <link rel="apple-touch-icon" href="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCAxMDAgMTAwIiBfiA9InN0eWxlPSJiYWNrZ3JvdW5kLWNvbG9yOiMwMDAwMDAiPjx0ZXh0IHk9Ii45ZW0iIGZvbnQtc2l6ZT0iOTAiPvCfjak8L3RleHQ+PC9zdmc+" />
    <meta name="theme-color" content="#EFEEE5">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&family=Space+Mono:wght@400;700&display=swap" rel="stylesheet">
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        bone: '#EFEEE5', 'bone-dark': '#E5E4DB', verified: '#1D9BF0', love: '#E0245E',
                    },
                    fontFamily: { mono: ['Space Mono', 'monospace'], sans: ['Inter', 'sans-serif'] },
                    borderWidth: { '12': '12px' },
                    animation: { 'fade-in': 'fadeIn 0.2s ease-out forwards' },
                    keyframes: { fadeIn: { '0%': { opacity: '0', transform: 'scale(0.95)' }, '100%': { opacity: '1', transform: 'scale(1)' } } }
                }
            }
        }
    </script>
    <style type="text/tailwindcss">
        body { font-family: theme('fontFamily.mono'); background-color: theme('colors.bone'); touch-action: manipulation; -webkit-tap-highlight-color: transparent; }
        .scrollbar-hide::-webkit-scrollbar { display: none; }
        .spin-animation { animation: spinText 0.1s linear infinite; }
        @keyframes spinText { 0% { opacity: 1; } 50% { opacity: 0.5; } 100% { opacity: 1; } }
        .celebrate { animation: celebrate 0.3s ease-in-out 3; }
        @keyframes celebrate { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.02); } }
        .confetti { position: fixed; width: 8px; height: 8px; top: -10px; animation: confetti-fall 3s ease-out forwards; }
        @keyframes confetti-fall { 0% { transform: translateY(-100%) rotate(0deg); opacity: 1; } 100% { transform: translateY(100vh) rotate(720deg); opacity: 0; } }
        .toast { animation: slideIn 0.3s ease-out, slideOut 0.3s ease-in 4.0s forwards; }
        @keyframes slideIn { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
        @keyframes slideOut { from { transform: translateX(0); opacity: 1; } to { transform: translateX(100%); opacity: 0; } }
    </style>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useCallback, useRef, useMemo } = React;

        // --- AUDIO ---
        const playTick = () => { try { const ctx = new (window.AudioContext||window.webkitAudioContext)(); const o=ctx.createOscillator(),g=ctx.createGain(); o.connect(g); g.connect(ctx.destination); o.type='square'; o.frequency.setValueAtTime(150,ctx.currentTime); o.frequency.exponentialRampToValueAtTime(40,ctx.currentTime+0.05); g.gain.setValueAtTime(0.1,ctx.currentTime); g.gain.exponentialRampToValueAtTime(0.01,ctx.currentTime+0.05); o.start(); o.stop(ctx.currentTime+0.05); } catch(e){} };
        const playWin = () => { try { const ctx = new (window.AudioContext||window.webkitAudioContext)(); [440,554.37,659.25].forEach((f,i)=>{ const o=ctx.createOscillator(),g=ctx.createGain(); o.connect(g); g.connect(ctx.destination); o.type='triangle'; o.frequency.value=f; g.gain.setValueAtTime(0,ctx.currentTime); g.gain.linearRampToValueAtTime(0.1,ctx.currentTime+0.1+(i*0.05)); g.gain.exponentialRampToValueAtTime(0.001,ctx.currentTime+1.5); o.start(ctx.currentTime+(i*0.05)); o.stop(ctx.currentTime+2); }); } catch(e){} };

        // --- CONSTANTS ---
        const GENRES = { 28:'Action',12:'Adventure',16:'Animation',35:'Comedy',80:'Crime',99:'Documentary',18:'Drama',10751:'Family',14:'Fantasy',36:'History',27:'Horror',10402:'Music',9648:'Mystery',10749:'Romance',878:'Sci-Fi',10770:'TV Movie',53:'Thriller',10752:'War',37:'Western' };
        
        const TRANSLATIONS = {
            'en-US': {
                TITLE: 'MOVIE ROULETTE', NAV_HOME: 'HOME', NAV_DISCOVER: 'DISCOVER', NAV_VERSUS: 'VERSUS', NAV_HISTORY: 'HISTORY', NAV_SETTINGS: 'SETTINGS',
                PLACEHOLDER_MOVIES: 'ADD MOVIE...', PLACEHOLDER_TV: 'ADD TV SHOW...', 
                SPIN_BTN: 'SPIN', SPINNING: 'SPINNING...', WINNER_MOVIE: "MOVIE NIGHT", WINNER_TV: "TV NIGHT",
                BTN_WATCHED: 'WATCHED', BTN_TRAILER: 'TRAILER', BTN_PROVIDERS: 'STREAMING',
                RATE_TITLE: 'RATING', RATE_LOVE: 'LOVED IT', RATE_NEUTRAL: 'OKAY', RATE_DISLIKE: 'BAD', RATE_SKIP: 'SKIP',
                DISCOVER_LOCKED: 'Rate 3 items to unlock!', DISCOVER_EMPTY: 'Finding matches...', BTN_LOAD_MORE: 'LOAD MORE',
                DISC_TOP: 'MATCHES', DISC_NEW: 'NEWEST', DISC_SOON: 'SOON', DISC_GENRE: 'GENRE',
                VERSUS_TITLE: 'TOURNAMENT', VERSUS_DESC: '8 Movies enter, 1 leaves.', VERSUS_START: 'START TOURNAMENT', VERSUS_WINNER: 'CHAMPION',
                STATS_TOTAL: 'WATCHED', STATS_GENRE: 'FAV GENRE', STATS_RATING: 'AVG SCORE',
                TOAST_ADDED: 'Added', TOAST_EXIST: 'Already in list', BTN_SEEN: 'SEEN IT'
            },
            'pt-PT': {
                TITLE: 'MOVIE ROULETTE', NAV_HOME: 'IN√çCIO', NAV_DISCOVER: 'DESCOBRIR', NAV_VERSUS: 'VERSUS', NAV_HISTORY: 'HIST√ìRICO', NAV_SETTINGS: 'OP√á√ïES',
                PLACEHOLDER_MOVIES: 'ADD FILME...', PLACEHOLDER_TV: 'ADD S√âRIE...', 
                SPIN_BTN: 'GIRAR', SPINNING: 'GIRANDO...', WINNER_MOVIE: "FILME", WINNER_TV: "S√âRIE",
                BTN_WATCHED: 'J√Å VI', BTN_TRAILER: 'TRAILER', BTN_PROVIDERS: 'ASSISTIR',
                RATE_TITLE: 'AVALIA√á√ÉO', RATE_LOVE: 'ADOREI', RATE_NEUTRAL: 'OK', RATE_DISLIKE: 'RUIM', RATE_SKIP: 'PULAR',
                DISCOVER_LOCKED: 'Avalie 3 itens para liberar!', DISCOVER_EMPTY: 'Procurando...', BTN_LOAD_MORE: 'CARREGAR MAIS',
                DISC_TOP: 'TOPS', DISC_NEW: 'RECENTES', DISC_SOON: 'BREVE', DISC_GENRE: 'G√âNERO',
                VERSUS_TITLE: 'TORNEIO', VERSUS_DESC: '8 Filmes entram, 1 sai.', VERSUS_START: 'INICIAR', VERSUS_WINNER: 'CAMPE√ÉO',
                STATS_TOTAL: 'VISTOS', STATS_GENRE: 'G√âNERO FAV', STATS_RATING: 'M√âDIA',
                TOAST_ADDED: 'Adicionado', TOAST_EXIST: 'J√° na lista', BTN_SEEN: 'J√Å VI'
            }
        };

        function generateId() { return Date.now().toString(36) + Math.random().toString(36).substr(2); }
        function formatDate(date) { if(!date) return ''; return new Date(date).toLocaleDateString('en-US', {month:'short',day:'numeric',year:'numeric'}).toUpperCase(); }

        // --- ICONS & UI ---
        const Icons = {
            Home: () => <svg className="w-5 h-5" fill="currentColor" viewBox="0 0 24 24"><path d="M10 20v-6h4v6h5v-8h3L12 3 2 12h3v8z"/></svg>,
            Discover: () => <svg className="w-5 h-5" fill="currentColor" viewBox="0 0 24 24"><path d="M12 17.27L18.18 21l-1.64-7.03L22 9.24l-7.19-.61L12 2 9.19 8.63 2 9.24l5.46 4.73L5.82 21z"/></svg>,
            Versus: () => <svg className="w-5 h-5" fill="currentColor" viewBox="0 0 24 24"><path d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm-7 2h2v2h-2V5zm0 4h2v2h-2V9zm0 4h2v2h-2v-2zm-4-8h2v2H8V5zm0 4h2v2H8V9zm0 4h2v2H8v-2zM5 5h2v2H5V5zm0 4h2v2H5V9zm0 4h2v2H5v-2z"/></svg>, // Simple Grid/Tournament rep
            History: () => <svg className="w-5 h-5" fill="currentColor" viewBox="0 0 24 24"><path d="M13 3c-4.97 0-9 4.03-9 9H1l3.89 3.89.07.14L9 12H6c0-3.87 3.13-7 7-7s7 3.13 7 7-3.13 7-7 7c-1.93 0-3.68-.79-4.94-2.06l-1.42 1.42C8.27 19.99 10.51 21 13 21c4.97 0 9-4.03 9-9s-4.03-9-9-9zm-1 5v5l4.28 2.54.72-1.21-3.5-2.08V8H12z"/></svg>,
            Settings: () => <svg className="w-5 h-5" fill="currentColor" viewBox="0 0 24 24"><path d="M19.14 12.94c.04-.3.06-.61.06-.94 0-.32-.02-.64-.07-.94l2.03-1.58c.18-.14.23-.41.12-.61l-1.92-3.32c-.12-.22-.37-.29-.59-.22l-2.39.96c-.5-.38-1.03-.7-1.62-.94l-.36-2.54c-.04-.24-.24-.41-.48-.41h-3.84c-.24 0-.43.17-.47.41l-.36 2.54c-.59.24-1.13.57-1.62.94l-2.39-.96c-.22-.08-.47 0-.59.22L3.16 8.87c-.12.21-.08.47.12.61l2.03 1.58c-.05.3-.09.63-.09.94s.02.64.07.94l-2.03 1.58c-.18.14-.23.41-.12.61l1.92 3.32c.12.22.37.29.59.22l2.39-.96c.5.38 1.03.7 1.62.94l.36 2.54c.05.24.24.41.48.41h3.84c.24 0 .44-.17.47-.41l.36-2.54c.59-.24 1.13-.56 1.62-.94l2.39.96c.22.08.47 0 .59-.22l1.92-3.32c.12-.22.07-.47-.12-.61l-2.01-1.58zM12 15.6c-1.98 0-3.6-1.62-3.6-3.6s1.62-3.6 3.6-3.6 3.6 1.62 3.6 3.6-1.62 3.6-3.6 3.6z"/></svg>,
            Check: () => <svg className="w-4 h-4 text-verified fill-current ml-1" viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/></svg>,
            Info: () => <svg className="w-4 h-4" viewBox="0 0 24 24" fill="currentColor"><path d="M11 7h2v2h-2zm0 4h2v6h-2zm1-9C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8z"/></svg>
        };

        function Toast({ msg }) { return <div className="toast fixed top-4 right-4 z-[99] bg-black text-bone px-4 py-3 border border-bone font-bold text-xs uppercase shadow-lg">{msg}</div>; }
        
        // --- DATA COMPONENTS ---
        function StatsHeader({ watched, t }) {
            const total = watched.length;
            const genres = watched.flatMap(w => w.tmdbData ? w.tmdbData.genre_ids : []);
            const topGenreId = genres.sort((a,b) => genres.filter(v => v===a).length - genres.filter(v => v===b).length).pop();
            const topGenre = GENRES[topGenreId] || '-';
            const ratedItems = watched.filter(w => w.rating === 'love' || w.rating === 'neutral' || w.rating === 'dislike');
            const avgScore = ratedItems.length ? Math.round((ratedItems.filter(r=>r.rating==='love').length * 100 + ratedItems.filter(r=>r.rating==='neutral').length * 50) / ratedItems.length) + '%' : '-';

            return (
                <div className="grid grid-cols-3 gap-2 mb-6 border-b border-black pb-6">
                    {[
                        { l: t('STATS_TOTAL'), v: total }, { l: t('STATS_GENRE'), v: topGenre }, { l: t('STATS_RATING'), v: avgScore }
                    ].map((s,i) => (
                        <div key={i} className="text-center">
                            <div className="text-2xl font-black">{s.v}</div>
                            <div className="text-[10px] font-bold text-gray-500 uppercase">{s.l}</div>
                        </div>
                    ))}
                </div>
            );
        }

        // --- GAME MODES ---
        function Tournament({ movies, onComplete, t }) {
            const [round, setRound] = useState([]);
            const [nextRound, setNextRound] = useState([]);
            const [currentMatch, setCurrentMatch] = useState(0);
            const [champion, setChampion] = useState(null);

            useEffect(() => {
                // Initialize
                const candidates = [...movies].sort(() => 0.5 - Math.random());
                // Fill if less than 8? For now, simpler: Just take up to 8 (must be power of 2: 2, 4, 8)
                let bracketSize = 8;
                if (candidates.length < 8) bracketSize = 4;
                if (candidates.length < 4) bracketSize = 2;
                
                // If user has < 2 movies, we can't play. But Parent should handle this check.
                const players = candidates.slice(0, bracketSize);
                const firstRound = [];
                for (let i = 0; i < players.length; i += 2) {
                    if (players[i+1]) firstRound.push([players[i], players[i+1]]);
                }
                setRound(firstRound);
            }, []);

            const handleVote = (winner) => {
                const updatedNext = [...nextRound, winner];
                if (currentMatch + 1 < round.length) {
                    setNextRound(updatedNext);
                    setCurrentMatch(currentMatch + 1);
                } else {
                    // End of round
                    if (updatedNext.length === 1) {
                        setChampion(updatedNext[0]);
                    } else {
                        // Setup next round
                        const newRound = [];
                        for (let i = 0; i < updatedNext.length; i += 2) {
                            newRound.push([updatedNext[i], updatedNext[i+1]]);
                        }
                        setRound(newRound);
                        setNextRound([]);
                        setCurrentMatch(0);
                    }
                }
            };

            if (champion) {
                return (
                    <div className="text-center p-8 celebrate">
                        <p className="text-sm font-bold uppercase text-[#1D9BF0] mb-2">{t('VERSUS_WINNER')}</p>
                        <div className="border-[12px] border-black p-4 mb-4 bg-white relative">
                            {champion.tmdbData && champion.tmdbData.poster_path ? 
                                <img src={`https://image.tmdb.org/t/p/w342${champion.tmdbData.poster_path}`} className="w-48 mx-auto" /> 
                                : <div className="w-48 h-72 bg-gray-800 mx-auto flex items-center justify-center text-4xl">?</div>}
                        </div>
                        <h2 className="text-3xl font-black uppercase mb-6">{champion.title}</h2>
                        <button onClick={() => onComplete(champion)} className="bg-black text-bone px-8 py-4 font-bold uppercase tracking-wider">
                            {t('BTN_WATCHED')}
                        </button>
                    </div>
                );
            }

            if (round.length === 0) return <div className="p-10 text-center uppercase font-bold">Loading Bracket...</div>;

            const match = round[currentMatch];
            return (
                <div className="h-full flex flex-col">
                    <div className="text-center mb-4 text-xs font-bold uppercase tracking-widest text-gray-500">
                        Match {currentMatch + 1} / {round.length} ‚Ä¢ Round of {round.length * 2}
                    </div>
                    <div className="flex-1 grid grid-cols-2 gap-2">
                        {match.map(m => (
                            <button key={m.id} onClick={() => handleVote(m)} className="relative group border-4 border-black bg-black h-full flex flex-col">
                                {m.tmdbData && m.tmdbData.poster_path ? (
                                    <div className="flex-1 overflow-hidden relative">
                                        <img src={`https://image.tmdb.org/t/p/w500${m.tmdbData.poster_path}`} className="absolute inset-0 w-full h-full object-cover group-hover:scale-105 transition-transform duration-300" />
                                        <div className="absolute inset-0 bg-black/0 group-hover:bg-black/20 transition-colors"></div>
                                    </div>
                                ) : (
                                    <div className="flex-1 bg-gray-800 flex items-center justify-center text-bone text-4xl font-bold">?</div>
                                )}
                                <div className="p-3 bg-bone border-t-4 border-black">
                                    <p className="font-bold text-xs uppercase line-clamp-2 leading-tight">{m.title}</p>
                                </div>
                            </button>
                        ))}
                    </div>
                </div>
            );
        }

        // --- INFO MODAL (Providers + Trailers) ---
        function InfoModal({ item, onClose, t, apiKey, language }) {
            const [providers, setProviders] = useState(null);
            const [trailer, setTrailer] = useState(null);
            const [playingTrailer, setPlayingTrailer] = useState(false);

            useEffect(() => {
                if (!item || !item.tmdbData || !apiKey) return;
                const fetchDetails = async () => {
                    const type = item.type === 'movie' || !item.type ? 'movie' : 'tv'; // Robust check
                    const region = language === 'pt-PT' ? 'PT' : 'US';
                    
                    // Providers
                    try {
                        const res = await fetch(`https://api.themoviedb.org/3/${type}/${item.tmdbData.id}/watch/providers?api_key=${apiKey}`);
                        const data = await res.json();
                        if (data.results && data.results[region]) {
                            setProviders(data.results[region].flatrate || data.results[region].buy); // Prioritize flatrate
                        }
                    } catch(e) {}

                    // Trailer
                    try {
                        const res = await fetch(`https://api.themoviedb.org/3/${type}/${item.tmdbData.id}/videos?api_key=${apiKey}&language=${language}`);
                        const data = await res.json();
                        // Fallback to English trailer if no local one
                        let vid = data.results.find(v => v.site === 'YouTube' && v.type === 'Trailer');
                        if (!vid && language !== 'en-US') {
                             const resEn = await fetch(`https://api.themoviedb.org/3/${type}/${item.tmdbData.id}/videos?api_key=${apiKey}&language=en-US`);
                             const dataEn = await resEn.json();
                             vid = dataEn.results.find(v => v.site === 'YouTube' && v.type === 'Trailer');
                        }
                        setTrailer(vid);
                    } catch(e) {}
                };
                fetchDetails();
            }, [item]);

            if (!item || !item.tmdbData) return null;
            const data = item.tmdbData;

            return (
                <div className="fixed inset-0 z-[60] flex items-center justify-center p-4 bg-black/90 backdrop-blur-sm animate-fade-in" onClick={onClose}>
                    <div className="max-w-2xl w-full bg-bone text-black border-4 border-black shadow-2xl relative overflow-hidden max-h-[90vh] overflow-y-auto" onClick={e => e.stopPropagation()}>
                        
                        {/* Header Image or Trailer */}
                        <div className="relative aspect-video bg-black">
                            {playingTrailer && trailer ? (
                                <iframe className="absolute inset-0 w-full h-full" src={`https://www.youtube.com/embed/${trailer.key}?autoplay=1`} frameBorder="0" allowFullScreen></iframe>
                            ) : (
                                <>
                                    {data.backdrop_path ? <img src={`https://image.tmdb.org/t/p/w780${data.backdrop_path}`} className="w-full h-full object-cover opacity-60" /> : <div className="w-full h-full bg-gray-800"></div>}
                                    <button onClick={onClose} className="absolute top-2 right-2 bg-black text-bone rounded-full p-2 hover:bg-red-600 transition-colors z-10">‚úï</button>
                                    {trailer && (
                                        <button onClick={() => setPlayingTrailer(true)} className="absolute inset-0 flex items-center justify-center group">
                                            <div className="bg-black/70 text-bone p-4 rounded-full border-2 border-bone group-hover:scale-110 transition-transform">
                                                <svg className="w-8 h-8 fill-current translate-x-0.5" viewBox="0 0 24 24"><path d="M8 5v14l11-7z"/></svg>
                                            </div>
                                        </button>
                                    )}
                                </>
                            )}
                        </div>

                        <div className="p-6">
                            <h2 className="text-2xl md:text-4xl font-black uppercase leading-none mb-2">{data.title || item.title} <Icons.Check /></h2>
                            <div className="flex flex-wrap gap-3 text-xs font-bold text-gray-500 mb-6 uppercase">
                                <span>{data.release_date?.split('-')[0] || t('UNKNOWN_YEAR')}</span>
                                {data.vote_average > 0 && <span>‚òÖ {data.vote_average.toFixed(1)}</span>}
                                {data.runtime > 0 && <span>{data.runtime}m</span>}
                            </div>

                            <p className="text-sm leading-relaxed font-sans mb-6">{data.overview || t('NO_PLOT')}</p>

                            {/* Providers */}
                            {providers && providers.length > 0 && (
                                <div className="border-t-2 border-black/10 pt-4">
                                    <p className="text-[10px] font-bold uppercase mb-2 text-gray-500">{t('BTN_PROVIDERS')}</p>
                                    <div className="flex flex-wrap gap-2">
                                        {providers.slice(0,5).map(p => (
                                            <img key={p.provider_id} src={`https://image.tmdb.org/t/p/w45${p.logo_path}`} className="w-8 h-8 rounded-md border border-black/20" title={p.provider_name} />
                                        ))}
                                    </div>
                                </div>
                            )}
                        </div>
                    </div>
                </div>
            );
        }

        // --- MAIN APP ---
        function App() {
            const [movies, setMovies] = useState([]);
            const [tvShows, setTvShows] = useState([]);
            const [watched, setWatched] = useState([]);
            const [apiKey, setApiKey] = useState('');
            const [language, setLanguage] = useState('en-US');
            const [soundEnabled, setSoundEnabled] = useState(true);
            const [currentTab, setCurrentTab] = useState('home'); // home, discover, versus, history, settings
            const [isSpinning, setIsSpinning] = useState(false);
            const [spinningText, setSpinningText] = useState('');
            const [selectedItem, setSelectedItem] = useState(null);
            const [showResult, setShowResult] = useState(false);
            const [showConfetti, setShowConfetti] = useState(false);
            const [showFilters, setShowFilters] = useState(false);
            const [filters, setFilters] = useState({ genres: [], time: null });
            const [toasts, setToasts] = useState([]);
            const [rateModalItem, setRateModalItem] = useState(null);
            const [infoItem, setInfoItem] = useState(null); // For Info Modal
            
            // --- DISCOVER STATE ---
            const [discoverPage, setDiscoverPage] = useState(1);
            const [discoverRecs, setDiscoverRecs] = useState([]);
            const [discoverMode, setDiscoverMode] = useState('top');
            const [discoverGenre, setDiscoverGenre] = useState(null);
            const [discoverLoading, setDiscoverLoading] = useState(false);

            // --- REFS ---
            const spinCandidatesRef = useRef([]); // Fixes spinning closure bug

            const t = (key) => TRANSLATIONS[language][key] || key;

            // --- INIT ---
            useEffect(() => {
                try {
                    const sm = localStorage.getItem(STORAGE_KEYS.movies); if (sm) setMovies(JSON.parse(sm));
                    const st = localStorage.getItem(STORAGE_KEYS.tvShows); if (st) setTvShows(JSON.parse(st));
                    const sw = localStorage.getItem(STORAGE_KEYS.watched); if (sw) setWatched(JSON.parse(sw));
                    const sk = localStorage.getItem(STORAGE_KEYS.tmdbKey); 
                    const HARDCODED = 'YOUR_ACTUAL_LONG_API_KEY_HERE'; 
                    if (HARDCODED && HARDCODED !== 'YOUR_ACTUAL_LONG_API_KEY_HERE') setApiKey(HARDCODED);
                    else if (sk) setApiKey(sk);
                    const sl = localStorage.getItem(STORAGE_KEYS.language); if (sl) setLanguage(sl);
                    const ss = localStorage.getItem(STORAGE_KEYS.sound); if (ss) setSoundEnabled(JSON.parse(ss));
                } catch (e) {}
            }, []);

            // --- PERSIST ---
            useEffect(() => localStorage.setItem(STORAGE_KEYS.movies, JSON.stringify(movies)), [movies]);
            useEffect(() => localStorage.setItem(STORAGE_KEYS.tvShows, JSON.stringify(tvShows)), [tvShows]);
            useEffect(() => localStorage.setItem(STORAGE_KEYS.watched, JSON.stringify(watched)), [watched]);
            useEffect(() => { if(apiKey) localStorage.setItem(STORAGE_KEYS.tmdbKey, apiKey); else localStorage.removeItem(STORAGE_KEYS.tmdbKey); }, [apiKey]);
            useEffect(() => localStorage.setItem(STORAGE_KEYS.language, language), [language]);
            useEffect(() => localStorage.setItem(STORAGE_KEYS.sound, JSON.stringify(soundEnabled)), [soundEnabled]);

            // --- HELPERS ---
            const showToast = (msg) => { const id = Date.now(); setToasts(p => [...p, { id, msg }]); setTimeout(() => setToasts(p => p.filter(t => t.id !== id)), 3000); };
            
            const handleAdd = (title, metadata) => {
                if (!title.trim()) return;
                const list = currentTab === 'tv' ? tvShows : movies; // Simplified for this view, actually input handles types
                // We'll trust the component calls.
                const newItem = { id: generateId(), title: metadata ? metadata.title : title, included: true, tmdbData: metadata, type: metadata && (metadata.title ? 'movie' : 'tv') };
                if (newItem.type === 'tv') setTvShows(p => [...p, newItem]); else setMovies(p => [...p, newItem]);
                showToast(t('TOAST_ADDED'));
            };

            const toggleIncluded = (id, type) => {
                const updater = p => p.map(i => i.id === id ? { ...i, included: !i.included } : i);
                if (type === 'movie') setMovies(updater); else setTvShows(updater);
            };

            const deleteItem = (id, type) => {
                if (type === 'movie') setMovies(p => p.filter(i => i.id !== id)); else setTvShows(p => p.filter(i => i.id !== id));
            };

            // --- ROULETTE LOGIC ---
            const spinRoulette = () => {
                // Combine enabled movies & TV
                const candidates = [...movies, ...tvShows].filter(i => i.included);
                
                // FILTER LOGIC
                const validCandidates = candidates.filter(item => {
                    if (filters.genres.length === 0 && !filters.time) return true;
                    if (!item.tmdbData) return false;
                    if (filters.genres.length > 0) { const g = item.tmdbData.genre_ids || []; if (!filters.genres.some(id => g.includes(id))) return false; }
                    if (filters.time) { 
                        const r = item.tmdbData.runtime; if (!r) return false; 
                        if (filters.time === 'short' && r > 90) return false;
                        if (filters.time === 'medium' && (r <= 90 || r > 120)) return false;
                        if (filters.time === 'long' && r <= 120) return false;
                    }
                    return true;
                });

                if (isSpinning || validCandidates.length === 0) return;
                
                spinCandidatesRef.current = validCandidates;
                setIsSpinning(true); setShowResult(false);
                
                const duration = 2500; const start = Date.now();
                const animate = () => {
                    const elapsed = Date.now() - start;
                    if (elapsed < duration) {
                        if (soundEnabled && Math.random() > 0.6) playTick();
                        setSpinningText(spinCandidatesRef.current[Math.floor(Math.random() * spinCandidatesRef.current.length)].title);
                        requestAnimationFrame(animate);
                    } else {
                        const winner = spinCandidatesRef.current[Math.floor(Math.random() * spinCandidatesRef.current.length)];
                        setSelectedItem(winner); setShowResult(true); setShowConfetti(true);
                        setIsSpinning(false); if(soundEnabled) playWin();
                        setTimeout(() => setShowConfetti(false), 4000);
                    }
                };
                animate();
            };

            // --- DISCOVER LOGIC ---
            useEffect(() => {
                if (currentTab !== 'discover' || !apiKey) return;
                // Fetch Recommendations logic
                const fetchDiscover = async () => {
                    if (discoverLoading) return;
                    setDiscoverLoading(true);
                    
                    // Seeds: Movies with ANY rating (Love/Neutral/Dislike) can be seeds, but we prioritize Love
                    const rated = watched.filter(w => w.rating && w.tmdbData);
                    if (rated.length === 0) { setDiscoverLoading(false); return; } // Locked state handled by render

                    try {
                        // Logic: Fetch recommendations for last 3 rated items
                        const seeds = rated.reverse().slice(0, 3);
                        let allRecs = [];
                        
                        // RELEASE RADAR Logic
                        if (discoverMode === 'soon') {
                            const res = await fetch(`https://api.themoviedb.org/3/movie/upcoming?api_key=${apiKey}&language=${language}&page=${discoverPage}`);
                            const data = await res.json();
                            allRecs = data.results || [];
                        } else {
                            // Standard Recommendation Logic
                            for (const seed of seeds) {
                                const type = seed.type === 'tv' ? 'tv' : 'movie';
                                const res = await fetch(`https://api.themoviedb.org/3/${type}/${seed.tmdbData.id}/recommendations?api_key=${apiKey}&language=${language}&page=${discoverPage}`);
                                const data = await res.json();
                                if (data.results) allRecs = [...allRecs, ...data.results];
                            }
                        }

                        // Process & Filter
                        const processed = allRecs.map(r => ({
                            ...r,
                            matchScore: Math.round(r.vote_average * 10),
                            releaseDate: new Date(r.release_date || r.first_air_date || 0)
                        }))
                        .filter(r => !watched.some(w => w.tmdbData && w.tmdbData.id === r.id)) // Not seen
                        .filter(r => !movies.some(m => m.tmdbData && m.tmdbData.id === r.id)) // Not in list
                        .filter(r => !tvShows.some(t => t.tmdbData && t.tmdbData.id === r.id))
                        // Dedupe by ID
                        .filter((v,i,a)=>a.findIndex(t=>(t.id === v.id))===i);

                        // Sort
                        if (discoverMode === 'top') processed.sort((a,b) => b.matchScore - a.matchScore);
                        if (discoverMode === 'new') processed.sort((a,b) => b.releaseDate - a.releaseDate);
                        if (discoverMode === 'genre' && discoverGenre) {
                            // Just filter, sort by score
                            const genreFiltered = processed.filter(r => r.genre_ids.includes(discoverGenre));
                            genreFiltered.sort((a,b) => b.matchScore - a.matchScore);
                            // If page 1, replace. If >1, append.
                            setDiscoverRecs(p => discoverPage === 1 ? genreFiltered : [...p, ...genreFiltered]);
                            setDiscoverLoading(false);
                            return; 
                        }

                        setDiscoverRecs(p => discoverPage === 1 ? processed : [...p, ...processed]);

                    } catch(e) { console.error(e); }
                    setDiscoverLoading(false);
                };

                fetchDiscover();
            }, [currentTab, discoverPage, discoverMode, discoverGenre]); // Re-run when these change

            // --- RENDER HELPERS ---
            const renderHome = () => (
                <div className="pb-32">
                    <header className="mb-6 border-[8px] border-[#722F37] p-6 relative">
                        <h1 className="text-4xl font-black uppercase text-center leading-none tracking-tighter">MOVIE<br/>ROULETTE</h1>
                        <div className="flex justify-center gap-4 mt-4 text-xs font-bold uppercase">
                            <span className="border-b-2 border-black">{movies.length} MOVIES</span>
                            <span className="border-b-2 border-black">{tvShows.length} TV</span>
                        </div>
                    </header>

                    {/* Inputs */}
                    <div className="flex flex-col gap-2 mb-6">
                        <div className="flex gap-2">
                            <SearchInput type="movie" apiKey={apiKey} language={language} placeholder={t('PLACEHOLDER_MOVIES')} onAdd={(t,m)=>handleAdd(t,{...m,type:'movie'})} />
                            <button className="bg-black text-bone px-4 font-bold text-xs">MOV</button>
                        </div>
                        <div className="flex gap-2">
                            <SearchInput type="tv" apiKey={apiKey} language={language} placeholder={t('PLACEHOLDER_TV')} onAdd={(t,m)=>handleAdd(t,{...m,type:'tv'})} />
                            <button className="bg-black text-bone px-4 font-bold text-xs">TV</button>
                        </div>
                    </div>

                    {/* Filter Toggle */}
                    <div className="flex justify-between items-center mb-2">
                        <h2 className="font-bold text-xs uppercase tracking-widest">{t('HEADER_MOVIES')}</h2>
                        <button onClick={()=>setShowFilters(!showFilters)} className={`text-[10px] font-bold border border-black px-2 py-1 uppercase ${showFilters ? 'bg-black text-bone' : ''}`}>
                            {t('FILTERS')}
                        </button>
                    </div>
                    <FilterPanel isOpen={showFilters} onClose={()=>setShowFilters(false)} filters={filters} setFilters={setFilters} t={t} />

                    {/* List */}
                    <div className="mb-6 max-h-64 overflow-y-auto border-t-2 border-b-2 border-black/10">
                        {/* Merge lists for display, or show tabs? Simplified: Show All */}
                        {[...movies, ...tvShows].length === 0 ? (
                            <div className="p-8 text-center text-gray-400">{t('EMPTY_LIST')}</div>
                        ) : (
                            [...movies, ...tvShows].map(item => (
                                <div key={item.id} className={`flex items-center gap-3 py-3 border-b border-gray-200 ${!item.included?'opacity-50':''}`}>
                                    <input type="checkbox" checked={item.included} onChange={()=>toggleIncluded(item.id, item.type || 'movie')} className="checkbox-receipt" />
                                    <div className="flex-1 min-w-0">
                                        <span className="font-bold uppercase text-sm truncate block">{item.title}</span>
                                        {item.tmdbData && <span className="text-[10px] text-gray-500 uppercase">{item.type==='tv'?'TV':'MOV'} ‚Ä¢ {item.tmdbData.vote_average} ‚òÖ</span>}
                                    </div>
                                    {item.tmdbData && <button onClick={()=>setInfoItem(item)} className="text-gray-400 hover:text-black"><Icons.Info/></button>}
                                    <button onClick={()=>deleteItem(item.id, item.type||'movie')} className="text-gray-400 hover:text-red-500 px-2">‚úï</button>
                                </div>
                            ))
                        )}
                    </div>

                    <button onClick={spinRoulette} disabled={isSpinning} className="w-full bg-black text-bone py-6 text-2xl font-black uppercase tracking-widest hover:bg-gray-900 active:scale-95 transition-transform disabled:opacity-50">
                        {isSpinning ? t('SPINNING') : t('SPIN_BTN')}
                    </button>
                </div>
            );

            return (
                <div className="min-h-screen bg-bone text-black relative font-mono select-none">
                    {/* View Container */}
                    <div className="max-w-xl mx-auto p-4 pb-24">
                        
                        {currentTab === 'home' && renderHome()}
                        
                        {currentTab === 'discover' && (
                            <div className="pb-24">
                                <h1 className="text-2xl font-black uppercase mb-4 border-b-4 border-black pb-2">{t('TAB_DISCOVER')}</h1>
                                {/* Discover Filters */}
                                <div className="flex gap-2 overflow-x-auto pb-4 mb-2">
                                    {['top', 'new', 'soon'].map(m => (
                                        <button key={m} onClick={()=>{setDiscoverMode(m); setDiscoverPage(1);}} className={`px-3 py-1 text-xs font-bold uppercase border border-black ${discoverMode===m?'bg-black text-bone':''}`}>
                                            {m === 'top' ? t('DISC_TOP') : m === 'new' ? t('DISC_NEW') : t('DISC_SOON')}
                                        </button>
                                    ))}
                                </div>
                                {watched.filter(w=>w.rating).length < 3 ? (
                                    <div className="p-10 border-2 border-dashed border-gray-400 text-center text-gray-500 font-bold uppercase">{t('DISCOVER_LOCKED')}</div>
                                ) : (
                                    <div className="grid grid-cols-2 gap-4">
                                        {discoverRecs.map(rec => (
                                            <div key={rec.id} className="border border-black bg-black text-bone flex flex-col">
                                                <div className="relative aspect-[2/3] overflow-hidden">
                                                    {rec.poster_path ? <img src={`https://image.tmdb.org/t/p/w342${rec.poster_path}`} className="w-full h-full object-cover" /> : <div className="w-full h-full bg-gray-800"></div>}
                                                    <div className="absolute top-2 right-2 bg-verified text-white text-[10px] font-bold px-1.5 py-0.5">{rec.matchScore}%</div>
                                                </div>
                                                <div className="p-2 flex flex-col gap-2 flex-1">
                                                    <p className="font-bold text-xs uppercase leading-tight line-clamp-2 flex-1">{rec.title || rec.name}</p>
                                                    <button onClick={()=>handleAddRecommendation(rec)} className="w-full bg-bone text-black text-[10px] font-bold py-2 uppercase hover:bg-white">+ {t('BTN_ADD_TO_LIST')}</button>
                                                    <button onClick={()=>{
                                                        // "Seen It" Logic
                                                        const dummy = { id: generateId(), title: rec.title||rec.name, tmdbData: rec };
                                                        setRateModalItem(dummy);
                                                    }} className="w-full border border-bone text-bone text-[10px] font-bold py-2 uppercase hover:bg-bone hover:text-black">‚úì {t('BTN_SEEN')}</button>
                                                </div>
                                            </div>
                                        ))}
                                    </div>
                                )}
                                {discoverRecs.length > 0 && (
                                    <button onClick={()=>setDiscoverPage(p=>p+1)} className="w-full mt-6 py-4 border-2 border-black font-bold uppercase hover:bg-black hover:text-bone">{t('BTN_LOAD_MORE')}</button>
                                )}
                            </div>
                        )}

                        {currentTab === 'versus' && (
                            <div className="h-[80vh] flex flex-col">
                                <h1 className="text-2xl font-black uppercase mb-4 border-b-4 border-black pb-2">{t('VERSUS_TITLE')}</h1>
                                <Tournament 
                                    movies={[...movies, ...tvShows]} 
                                    t={t}
                                    onComplete={(winner) => {
                                        showToast(`${t('VERSUS_WINNER')}: ${winner.title}`);
                                        // Optional: Add to history automatically? Or just show celebration.
                                    }}
                                />
                            </div>
                        )}

                        {currentTab === 'history' && (
                            <div className="pb-24">
                                <h1 className="text-2xl font-black uppercase mb-4 border-b-4 border-black pb-2">{t('NAV_HISTORY')}</h1>
                                <StatsHeader watched={watched} t={t} />
                                {watched.map(item => (
                                    <div key={item.id} className="flex items-center gap-3 py-3 border-b border-gray-300">
                                        {item.tmdbData?.poster_path && <img src={`https://image.tmdb.org/t/p/w92${item.tmdbData.poster_path}`} className="w-10 h-14 object-cover border border-black" />}
                                        <div className="flex-1">
                                            <span className="font-bold uppercase text-xs block">{item.title}</span>
                                            <span className="text-[10px] text-gray-500 uppercase">{formatDate(item.watchedDate)}</span>
                                        </div>
                                        <div className="flex gap-2">
                                            <button onClick={()=>setRateModalItem(item)} className={`text-[10px] font-bold border border-black px-2 py-1 uppercase ${item.rating==='love'?'bg-love text-white':''}`}>
                                                {item.rating ? (item.rating==='love'?'üòç':item.rating==='neutral'?'üòê':'üëé') : t('RATE_LABEL_ADD')}
                                            </button>
                                            {item.tmdbData && <button onClick={()=>setInfoItem(item)}><Icons.Info /></button>}
                                        </div>
                                    </div>
                                ))}
                            </div>
                        )}

                        {currentTab === 'settings' && (
                            <div className="pb-24">
                                <h1 className="text-2xl font-black uppercase mb-6">{t('SETTINGS_TITLE')}</h1>
                                <div className="space-y-6">
                                    <div>
                                        <label className="block text-xs font-bold uppercase mb-2">{t('SETTINGS_LANG_LABEL')}</label>
                                        <select value={language} onChange={e=>setLanguage(e.target.value)} className="w-full p-4 border-2 border-black bg-transparent font-bold uppercase"><option value="en-US">ENGLISH</option><option value="pt-PT">PORTUGU√äS</option></select>
                                    </div>
                                    <div className="flex items-center gap-4 border-2 border-black p-4">
                                        <input type="checkbox" checked={soundEnabled} onChange={e=>setSoundEnabled(e.target.checked)} className="checkbox-receipt" />
                                        <span className="font-bold uppercase">{t('SOUND')}</span>
                                    </div>
                                    <div>
                                        <label className="block text-xs font-bold uppercase mb-2">{t('SETTINGS_API_LABEL')}</label>
                                        <input type="text" value={apiKey} onChange={e=>setApiKey(e.target.value)} className="w-full p-4 border-2 border-black bg-transparent font-mono text-xs" placeholder="API KEY" />
                                    </div>
                                    <div className="pt-6 border-t-2 border-black">
                                        <button onClick={()=>fileInputRef.current.click()} className="w-full py-3 border-2 border-black mb-2 font-bold uppercase hover:bg-black hover:text-bone">{t('IMPORT')}</button>
                                        <input ref={fileInputRef} type="file" className="hidden" onChange={e => importData(e.target.files[0])} />
                                        <button onClick={exportData} className="w-full py-3 bg-black text-bone font-bold uppercase hover:bg-gray-800">{t('EXPORT')}</button>
                                    </div>
                                </div>
                            </div>
                        )}
                    </div>

                    {/* FIXED BOTTOM NAV */}
                    <div className="fixed bottom-0 left-0 right-0 bg-[#EFEEE5] border-t-4 border-black pb-safe z-50">
                        <div className="flex justify-around items-center h-16">
                            <button onClick={()=>setCurrentTab('home')} className={`flex-1 flex flex-col items-center justify-center h-full ${currentTab==='home'?'text-black':'text-gray-400'}`}><Icons.Home/><span className="text-[9px] font-bold uppercase mt-1">{t('NAV_HOME')}</span></button>
                            <button onClick={()=>setCurrentTab('discover')} className={`flex-1 flex flex-col items-center justify-center h-full ${currentTab==='discover'?'text-black':'text-gray-400'}`}><Icons.Discover/><span className="text-[9px] font-bold uppercase mt-1">{t('NAV_DISCOVER')}</span></button>
                            <button onClick={()=>setCurrentTab('versus')} className={`flex-1 flex flex-col items-center justify-center h-full ${currentTab==='versus'?'text-black':'text-gray-400'}`}><Icons.Versus/><span className="text-[9px] font-bold uppercase mt-1">{t('NAV_VERSUS')}</span></button>
                            <button onClick={()=>setCurrentTab('history')} className={`flex-1 flex flex-col items-center justify-center h-full ${currentTab==='history'?'text-black':'text-gray-400'}`}><Icons.History/><span className="text-[9px] font-bold uppercase mt-1">{t('NAV_HISTORY')}</span></button>
                            <button onClick={()=>setCurrentTab('settings')} className={`flex-1 flex flex-col items-center justify-center h-full ${currentTab==='settings'?'text-black':'text-gray-400'}`}><Icons.Settings/><span className="text-[9px] font-bold uppercase mt-1">{t('NAV_SETTINGS')}</span></button>
                        </div>
                    </div>

                    {/* MODALS & OVERLAYS */}
                    {showResult && selectedItem && (
                        <div className="fixed inset-0 z-[60] bg-black/90 flex items-center justify-center p-6 animate-fade-in" onClick={()=>setShowResult(false)}>
                            <div className="bg-bone w-full max-w-md border-[12px] border-black p-6 text-center relative celebrate" onClick={e=>e.stopPropagation()}>
                                <p className="text-xs font-bold uppercase tracking-widest text-gray-500 mb-2">{t('WINNER_MOVIE')}</p>
                                {selectedItem.tmdbData && selectedItem.tmdbData.poster_path ? 
                                    <img src={`https://image.tmdb.org/t/p/w342${selectedItem.tmdbData.poster_path}`} className="w-40 mx-auto border-4 border-black mb-4 shadow-xl" />
                                    : <div className="w-40 h-60 bg-gray-800 mx-auto mb-4 flex items-center justify-center text-4xl">?</div>
                                }
                                <h2 className="text-3xl font-black uppercase leading-tight mb-6">{selectedItem.title}</h2>
                                <button onClick={()=>initiateMarkAsWatched(selectedItem)} className="w-full py-4 bg-black text-bone font-bold uppercase tracking-widest hover:bg-gray-800">{t('BTN_WATCHED')}</button>
                            </div>
                        </div>
                    )}

                    <InfoModal item={infoItem} onClose={()=>setInfoItem(null)} t={t} apiKey={apiKey} language={language} />
                    
                    <RateModal 
                        isOpen={!!rateModalItem} 
                        onClose={()=>setRateModalItem(null)} 
                        onRate={(rating) => {
                            // Wrapper to pass rateModalItem correctly
                            const item = rateModalItem;
                            // Logic duplicated from confirmWatched but we need access to state functions
                            // We can actually just call the main confirmWatched if we lift state or keep it in App scope
                            // Fortunately, RateModal is inside App, so we pass confirmWatched directly
                            // But confirmWatched relies on 'rateModalItem' state which is set.
                            // However, we need to ensure confirmWatched uses the correct "selectedItemType" logic if strictly needed
                            // For simplicity, we assume confirmWatched handles it.
                        }}
                        // Actually, pass confirmWatched directly to onRate
                        onRate={confirmWatched}
                        t={t} 
                    />

                    <div className="fixed top-4 right-4 z-[100] flex flex-col gap-2 pointer-events-none">{toasts.map(t => <Toast key={t.id} msg={t.msg} />)}</div>
                    {showConfetti && <Confetti />}
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
